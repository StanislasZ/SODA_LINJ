<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns:line-height="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <style type="text/css">
        .input-group-text{
            display:block;
            width: 200px;
            float:left;
            text-align:right;
        }
        .status_stop{
            font-weight: bold;
            color: red;

        }
        .status_pause{
            font-weight: bold;
            color:yellowgreen;
        }
        .status_running{
            font-weight: bold;
            color: forestgreen;
        }
        .status_error{
            font-weight: bold;
            color:brown;
            font-size: large;
        }
        .a_hidden{
            display: none;
        }
        .a_in_action{
            margin-left: 5px;
            width: 65px;
        }
        .field_in_action{
            margin-left: 4px;
            width: 60px;
         }

        .th_in_tasklist{
            text-align: center;
            font-size: 1rem;
        }
        .td_in_tasklist{
            vertical-align: middle;
            text-align: center;
            font-size: 1rem;
        }

        .badge_status{
            font-size: 1rem;
            background-color: #5b1863;
        }
        .button_in_field_design{

            margin-left: 10px;
            margin-bottom: 10px;

            height: 90%;
            width: fit-content;

        }
        .mymodal{

            position:absolute;
            left:0px;

        }



    </style>


    <script type="text/javascript">
        // $(function(){
        //     $(".modal-dialog").draggable();
        // });
        // $(document).on("show.bs.modal", ".modal", function(){
        //     $(this).draggable();
        //     $(this).css("overflow-y", "scroll");
        //     // 防止出现滚动条，出现的话，你会把滚动条一起拖着走的
        // });


    </script>
    <script type="text/javascript">
        // var t = setInterval(function(){
        //     viewmodel.request();
        // }, 1000);


        $("#exampleModal").on("hidden.bs.modal",function(){
            $(document.body).addClass("modal-open");
        });



    </script>
    <script type="text/javascript">
        window.onload = function(){
            viewmodel.request();

        };
        // var sendMsg = function(){
        //     alert('按钮已点击执行');
        // };

        // window.onload=listenJsonFile();
        //
        // function listenJsonFile() {  //监听jsonfile所在的文件夹
        //     console.log('listen...');
        //     var d={};
        //     $.ajax({
        //         //接口地址
        //         url: "/html/listenJsonFile",
        //         type: 'POST',
        //         contentType: "application/json;charset=utf-8",
        //         dataType : 'json',
        //         data: JSON.stringify(d),
        //         async: false,
        //         cache: false,
        //         processData: false,
        //         success: function (response) {
        //             //成功的回调
        //             if(response.success){
        //                 $('#alert_in_tasklist').html(response.message).removeClass('alert-warning').addClass('alert-success th_in_tasklist').show().delay(2500).fadeOut();
        //             }else{
        //                 $('#alert_in_tasklist').html(response.message).removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
        //             }
        //             viewmodel.request();
        //             //listenJsonFile();
        //
        //         },
        //         error: function (returndata) {
        //             //请求异常的回调
        //             // modals.warn("网络访问失败，请稍后重试!");
        //         }
        //     });
        //
        // }

    </script>

    <script>

        function checktaskname(r) {
            var v=r.value;
            //console.log('value is '+v);

            var vali=document.getElementById("vali_taskname");
            if(v=="") {
                vali.innerText = "please input task name!";
            }else{
                vali.innerText = "";
            }
        }
        function checkhost(r) {
            var v=r.value;
            //console.log('value is '+v);

            var vali=document.getElementById("vali_host");
            if(v=="") {
                vali.innerText = "please input host!";
            }else{
                vali.innerText = "";
            }
        }
        function checkport(r) {
            var v=r.value;
            //console.log('value is '+v);

            var vali=document.getElementById("vali_port");
            if(v=="") {
                vali.innerText = "please input port!";
            }else{
                vali.innerText = "";
            }
        }
        function checktopic(r) {
            var v=r.value;
            //console.log('value is '+v);

            var vali=document.getElementById("vali_topic");
            if(v=="") {
                vali.innerText = "please input topic!";
            }else{
                vali.innerText = "";
            }
        }
        function checkinterval(r) {
            var v=r.value;
            //console.log('value is '+v);

            var vali=document.getElementById("vali_interval");
            if(v=="") {
                vali.innerText = "please input interval!";
            }else{
                vali.innerText = "";
            }
        }
        function checktotaltime(r) {
            var v=r.value;
            //console.log('value is '+v);

            var vali=document.getElementById("vali_totaltime");
            if(v=="") {
                vali.innerText = "please input time!";
            }else{
                vali.innerText = "";
            }
        }
        function checkfile(r) {
            var v=r.value;
            //console.log('value is '+v);

            var vali=document.getElementById("vali_file_update");
            if(v=="") {
                vali.innerText = "please choose file!";
            }else{
                vali.innerText = "";
            }
        }

        //删除表中的某行
        function mydeleteRow(r){
            //1.直接删除表格的一行
            // console.log('r is '+r.name);
            // console.log(r.parentNode);
            // console.log(r.parentNode.parentNode);
            //
            // var i=r.parentNode.parentNode.rowIndex;
            // document.getElementById('tasklist').deleteRow(i);

            //2.调用后台方法，把文件夹里的文件删掉
            var tr=r.parentNode.parentNode;
            var jfn;
            var celllist=tr.cells;
            for(var k=0;k<celllist.length;k++){

                if(celllist[k].id=="statusinlist"){
                    if(celllist[k].innerText=="#{status.running}"||celllist[k].innerText=="#{status.pause}"){
                        //alert('please stop the task first!');

                        $('#alert_in_tasklist').html('please stop the task first!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(2500).fadeOut();

                        return;
                    }
                }


                if(celllist[k].id=="jsonfilename"){
                    console.log(celllist[k].innerHTML);
                    console.log('id is '+celllist[k].id);
                    console.log('find it!!!');
                    jfn=celllist[k].innerText;
                    console.log('val is '+celllist[k].innerText);
                }
            }
            console.log('jsonfilename is '+jfn);

            var d={};
            d.jsonfilename=jfn;
            $.ajax({
                //接口地址
                url: "/html/deleteJsonFile",
                type: 'POST',
                contentType: "application/json;charset=utf-8",
                dataType : 'json',
                data: JSON.stringify(d),
                async: false,
                cache: false,
                processData: false,
                success: function (response) {
                    //成功的回调
                    if(response.success){
                        //alert(response.message);
                        if(response.success){
                            $('#alert_in_tasklist').html(response.message).removeClass('alert-warning').addClass('alert-success th_in_tasklist').show().delay(2500).fadeOut();
                        }else{
                            $('#alert_in_tasklist').html(response.message).removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(2500).fadeOut();
                        }
                    }
                    //viewmodel.request();
                },
                error: function (returndata) {
                    //请求异常的回调
                    // modals.warn("网络访问失败，请稍后重试!");
                }
            });
        }
        function stopTask(r){
            var tr=r.parentNode.parentNode;
            var jfn;
            var celllist=tr.cells;
            for(var k=0;k<celllist.length;k++){
                if(celllist[k].id=="jsonfilename"){
                    jfn=celllist[k].innerText;
                }
            }
            var d={};
            d.jsonfilename=jfn;
            $.ajax({
                //接口地址
                url: "/html/stop",
                type: 'POST',
                contentType: "application/json;charset=utf-8",
                dataType : 'json',
                data: JSON.stringify(d),
                async: false,
                cache: false,
                processData: false,
                success: function (response) {
                    //成功的回调
                    if(response.success){
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-warning').addClass('alert-success th_in_tasklist').show().delay(2500).fadeOut();
                    }else{
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(2500).fadeOut();
                    }
                    //viewmodel.request();
                },
                error: function (returndata) {
                    //请求异常的回调
                    // modals.warn("网络访问失败，请稍后重试!");
                }
            });

        }
        function pauseTask(r) {
            console.log('test pause...')
            var tr=r.parentNode.parentNode;
            var jfn;
            var celllist=tr.cells;
            for(var k=0;k<celllist.length;k++){
                if(celllist[k].id=="jsonfilename"){
                    jfn=celllist[k].innerText;
                    console.log('jfn='+jfn)
                }
            }
            var d={};
            d.jsonfilename=jfn;
            $.ajax({
                //接口地址
                url: "/html/pause",
                type: 'POST',
                contentType: "application/json;charset=utf-8",
                dataType : 'json',
                data: JSON.stringify(d),
                async: false,
                cache: false,
                processData: false,
                success: function (response) {
                    //成功的回调
                    if(response.success){
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-warning').addClass('alert-success th_in_tasklist').show().delay(2500).fadeOut();
                    }else{
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(2500).fadeOut();
                    }
                    //viewmodel.request();
                },
                error: function (returndata) {
                    //请求异常的回调
                    // modals.warn("网络访问失败，请稍后重试!");
                }
            });
        }
        function startTask(r) {
            var tr=r.parentNode.parentNode;
            var jfn;
            var celllist=tr.cells;
            for(var k=0;k<celllist.length;k++){
                if(celllist[k].id=="jsonfilename"){
                    jfn=celllist[k].innerText;
                }
            }
            var d={};
            d.jsonfilename=jfn;
            $.ajax({
                //接口地址
                url: "/html/start",
                type: 'POST',
                contentType: "application/json;charset=utf-8",
                dataType : 'json',
                data: JSON.stringify(d),
                async: false,
                cache: false,
                processData: false,
                success: function (response) {
                    //成功的回调
                    if(response.success){
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-warning').addClass('alert-success th_in_tasklist').show().delay(2500).fadeOut();
                    }else{
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                    }
                    //viewmodel.request();

                },
                error: function (returndata) {
                    //请求异常的回调
                    // modals.warn("网络访问失败，请稍后重试!");
                }
            });

        }

        function sendUniqueInfo(r) {

            document.getElementById('file_button_div').style.display="flex";
            document.getElementById('file_upload_div').style.display="none";

            var file = document.getElementById("file_update");
            if (file.outerHTML) {
                file.outerHTML = file.outerHTML;
            } else { // FF(包括3.5)
                file.value = "";
            }



            var tr=r.parentNode.parentNode;
            //console.log('tr length is '+tr.cells.length);
            var celllist=tr.cells;

            //把该行的内容放到modal中
            for(var k=0;k<celllist.length;k++){
                if(celllist[k].id=="topicinlist"){
                    $("#topic_update").val(celllist[k].innerText.trim());
                }else if(celllist[k].id=="hostinlist"){
                    $("#host_update").val(celllist[k].innerText);
                }else if(celllist[k].id=="portinlist"){
                    $("#port_update").val(celllist[k].innerText);
                }else if(celllist[k].id=="tasknameinlist"){
                    $("#taskname_update").val(celllist[k].innerText.trim());
                }else if(celllist[k].id=="intervalinlist"){
                    $("#interval_update").val(celllist[k].innerText);
                }else if(celllist[k].id=="totaltimeinlist"){
                    $("#time_update").val(celllist[k].innerText);
                }else if(celllist[k].id=="jsonfilename"){
                    $("#jsonname_update").val(celllist[k].innerText);
                }else if(celllist[k].id=="patterninlist"){
                    var pattern_v=celllist[k].innerText;
                    var radiolen=document.form_update.pattern.length;
                    //console.log('radio length is '+radiolen);
                    for(var i=0;i<radiolen;i++){
                        if(pattern_v==document.form_update.pattern[i].value){
                            document.form_update.pattern[i].checked=true;
                            document.getElementById('pattern_select_update').options[i+1].selected=true;
                         }
                    }
                }

            }

        }

        function showFileUpload(r) {
            var file_in_update=document.getElementById('file_upload_div');
            file_in_update.style.display="flex";
            var btn_div=document.getElementById('file_button_div');
            btn_div.style.display="none";

        }

        function submitUpdate() {
            {
                if (myCheckUpdate() == true) {
                    var formData = new FormData($("#form_update")[0]);
                    $.ajax({
                        //接口地址
                        url: '/html/updateTask',
                        type: 'POST',
                        data: formData,
                        async: false,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function (data) {
                            //成功的回调
                            var avalonbtn = document.getElementById("avalon");
                            $('#alert_in_tasklist').html('update task success!').removeClass('alert-warning').addClass('alert-success th_in_tasklist').show().delay(2500).fadeOut();
                            //avalonbtn.ms-click();
                            //viewmodel.request();

                        },
                        error: function (returndata) {
                            //请求异常的回调
                            // modals.warn("网络访问失败，请稍后重试!");
                        }
                    });
                    var closemodal = document.getElementById("closemodal_update");
                    closemodal.click();  //正确save就关闭那个模态窗口
                }
            }




            function myCheckUpdate()
            {
                //for(var i=1;i<document.taskform.elements.length-1;i++)
                for(var i=1;i<=8;i++)
                {
                    if(document.form_update.elements[i].value=="")
                    {
                        if(document.form_update.elements[i].name=="file"){
                            //console.log('oukai!!');
                            continue;
                        }else if(document.form_update.elements[i].id=="show_file_upload"){
                            continue;
                        }




                        console.log('empty name is '+document.form_update.elements[i].name);
                        console.log('empty is '+document.form_update.elements[i].innerText);
                        console.log('empty is '+document.form_update.elements[i].innerHTML);
                        //alert("The form has empty input!!");
                        $('#alert_in_tasklist').html('The form has empty input!!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(2500).fadeOut();
                        //document.taskform.elements[i].focus();
                        return false;
                    }
                }
                return true;

            }

        }

        //ajax上传
        function submitFunction() {

            {
                if(myCheck()==true)
                {
                    //这里唯一需要注意的就是这个form-add的id
                    var formData = new FormData($("#taskform")[0]);
                    $.ajax({
                        //接口地址
                        url: '/html/saveTask' ,
                        type: 'POST',
                        data: formData,
                        async: false,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function (data) {
                            //成功的回调
                            var avalonbtn=document.getElementById("avalon");
                            $('#alert_in_tasklist').html('save task success!').removeClass('alert-warning').addClass('alert-success th_in_tasklist').show().delay(2500).fadeOut();
                            //avalonbtn.ms-click();
                            //viewmodel.request();
                            removeBackground();
                            //location.reload();

                        },
                        error: function (returndata) {
                            //请求异常的回调
                            // modals.warn("网络访问失败，请稍后重试!");
                        }
                    });

                    var closemodal=document.getElementById("closemodal");
                    closemodal.click();  //正确save就关闭那个模态窗口



                }
            }
            function myCheck()
            {
                var file_choose_value=$('#file').val();
                var file_generate_value=$('#file_generate_name').val();
                if(!(file_choose_value||file_generate_value)){
                    $('#alert_in_tasklist').html('The form has empty file input!!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(2500).fadeOut();
                    //document.taskform.elements[i].focus();
                    return false;
                }




                //for(var i=1;i<document.taskform.elements.length-1;i++)
                for(var i=1;i<=9;i++)
                {
                    if(document.taskform.elements[i].value=="")
                    {
                        if(document.taskform.elements[i].id=="dataSource_out"){
                            //console.log('oukai!!');
                            continue;
                        }else if(document.taskform.elements[i].id=="dataSource_in"){
                            continue;
                        }else if(document.taskform.elements[i].id=="file_generate_name"){
                            continue;
                        }else if(document.taskform.elements[i].id=="file"){
                            continue;
                        }else if(document.taskform.elements[i].id=="dataSource_goback"){
                            continue;
                        }

                        console.log("name is "+document.taskform.elements[i].name);
                        console.log('empty is '+document.taskform.elements[i].innerText);
                        console.log('empty is '+document.taskform.elements[i].innerHTML);

                        //alert("The form has empty input!!");
                        $('#alert_in_tasklist').html('The form has empty input!!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(2500).fadeOut();
                        //document.taskform.elements[i].focus();
                        return false;
                    }
                }
                return true;

            }

        }

        function selectFile(input) {

            checkfile(input);

            var fileName = input.value;
            if(fileName.length > 1 && fileName ) {

                //如果选择了文件，应该把在线生成的那个文件名所在的input清空
                $('#file_generate_name').val("");
                $('#div_file_generate_name').hide();


                var ldot = fileName.lastIndexOf(".");
                if(ldot>=0){
                    var type = fileName.substring(ldot + 1);
                    //console.log('suffix is '+type);
                    if(type != "csv"&&type!="txt"&&type!="json"&&type!="log") {
                        //alert('please check your file is correct!!');
                        $('#alert_in_tasklist').html('please check your file is correct!!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(2500).fadeOut();
                        //清除当前所选文件
                        input.outerHTML=input.outerHTML.replace(/(value=\").+\"/i,"$1\"");
                    }
                }

            }
        }

        function select2radio(r) {
            var option=$("#pattern_select option:selected");
            console.log('select '+option.val());
            option_value=option.val();
            if(option_value=="minute"){
                document.taskform.pattern[0].checked=true;
            }else if(option_value=="second"){
                document.taskform.pattern[1].checked=true;
            }else if(option_value=="cycle"){
                document.taskform.pattern[2].checked=true;
            }

        }
        function select2radio_update(r) {
            var option=$("#pattern_select_update option:selected");
            console.log('select '+option.val());
            option_value=option.val();
            if(option_value=="minute"){
                document.form_update.pattern[0].checked=true;
            }else if(option_value=="second"){
                document.form_update.pattern[1].checked=true;
            }else if(option_value=="cycle"){
                document.form_update.pattern[2].checked=true;
            }

        }

        function set_select_checked(selectId, checkValue){
            var select = document.getElementById(selectId);

            for (var i = 0; i < select.options.length; i++){
                if (select.options[i].value == checkValue){
                    select.options[i].selected = true;
                    break;
                }
            }
        }
        
        function switchTimeAndCycle(r) {

            console.log($("#radio_cycle").css('display'));

            if($('#radio_cycle').css('display')=="none"){
                console.log('time2circle!!!!!');
                $("#button_switch").text("Use Time");
                //$('#radio_minute').removeAttr("checked");
                //$('#radio_minute').removeAttr("checked");
                $('#radio_cycle').css({"display":"block"});
                //$('#radio_cycle').attr("checked",true).prop("checked",true);  //选中发几遍的模式

                document.taskform.pattern[0].checked=false;
                document.taskform.pattern[1].checked=false;
                document.taskform.pattern[2].checked=true;

                $('#circle_span').css({"display":"inline"});

                $('#radio_minute').css({"display":"none"});
                $('#minute_span').css({"display":"none"});
                $('#radio_second').css({"display":"none"});
                $('#second_span').css({"display":"none"});

            }else{
                console.log('circle2time!!!!!');
                $("#button_switch").text("Use Cycle");
                //$('#radio_cycle').removeAttr("checked");
                $('#radio_minute').css({"display":"block"});

                //$('#radio_mintue').attr("checked",true).prop("checked",true);  //选中总时长的模式
                document.taskform.pattern[1].checked=false;
                document.taskform.pattern[2].checked=false;
                document.taskform.pattern[0].checked=true;

                $('#minute_span').css({"display":"inline"});
                $('#radio_second').css({"display":"block"});
                $('#second_span').css({"display":"inline"});

                $('#radio_cycle').css({"display":"none"});
                $('#circle_span').css({"display":"none"});

            }



        }

        function switchTimeAndCycle_update(r) {
            if($('#pattern_cycle').css('display')=="none"){
                console.log('time2circle!!!!!');
                $("#button_switch_update").text("Use Time");
                $('#pattern_cycle').css({"display":"block"});
                $('#cycle_span_update').css({"display":"inline"});
                //$('#radio_cycle').attr("checked",true).prop("checked",true);  //选中发几遍的模式

                document.form_update.pattern[0].checked=false;
                document.form_update.pattern[1].checked=false;
                document.form_update.pattern[2].checked=true;


                $('#pattern_min').css({"display":"none"});
                $('#minute_span_update').css({"display":"none"});
                $('#pattern_sec').css({"display":"none"});
                $('#second_span_update').css({"display":"none"});

            }else{
                console.log('circle2time!!!!!');
                $("#button_switch_update").text("Use Cycle");


                //$('#radio_mintue').attr("checked",true).prop("checked",true);  //选中总时长的模式
                document.form_update.pattern[1].checked=false;
                document.form_update.pattern[2].checked=false;
                document.form_update.pattern[0].checked=true;
                $('#pattern_min').css({"display":"block"});
                $('#minute_span_update').css({"display":"inline"});
                $('#pattern_sec').css({"display":"block"});
                $('#second_span_update').css({"display":"inline"});

                $('#pattern_cycle').css({"display":"none"});
                $('#cycle_span_update').css({"display":"none"});

            }




        }

        function choose_file_from_local(r) {

            $('#dataSource_out').hide();
            $('#dataSource_in').hide();
            $('#file').show();
            $('#dataSource_goback').show();

        }

        function reset_saveModal(r) {
            console.log('good');
            $('#dataSource_out').show();
            $('#dataSource_in').show();
            $('#file').hide();
            $('#dataSource_goback').hide();
            //input恢复
            $('#taskname').val("");
            $('#topic').val("");
            $('#file_generate_name').val("");
            check_file_generate_name();
        }

        function show_type_div(r) {
            //进入时就刷新field table
            $('#refresh_field_button').click();
            //进入时设置一些隐藏和显示
            checkNumberType();
            checkValueType();

            var type=$('#type_field_value option:selected').val();
            console.log('type is '+type);
            if (type=='string'){
                $('#div_field_string').show();
                $('#div_field_number').hide();
                $('#div_field_date').hide();
            }else if (type=='date'){
                $('#div_field_date').show();
                $('#div_field_string').hide();
                $('#div_field_number').hide();
            }else if (type=='number'){
                $('#div_field_number').show();
                $('#div_field_string').hide();
                $('#div_field_date').hide();
            }else{
                $('#div_field_number').hide();
                $('#div_field_string').hide();
                $('#div_field_date').hide();
            }

        }

        //判断是否为数字
        function checkRate(number) {
            var re = /^[0-9]+.?[0-9]*$/; //判断字符串是否为数字 //判断正整数 /^[1-9]+[0-9]*]*$/
            //var nubmer = document.getElementById(input).value;

            if (!re.test(number)) {
                $('#alert_in_tasklist').html('The parameter should be correct number!!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                console.log('The parameter should be correct number!');
                return false;
            }
            return true;
        }


        function save_field(r) {
            var type=$('#type_field_value option:selected').val().replace(" ","");
            var number_type;
            var date_format;
            console.log('type is '+type);
            var field_data={};
            field_data.field_name=$.trim($('#field_name').val());
            console.log('save时，fieldname='+field_data.field_name);
            field_data.field_type=type;
            if(field_data.field_name==""){    //check field name
                $('#alert_in_tasklist').html('please input field name!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                return;
            }
            if(type=="Choose Type..."){   //check field type
                $('#alert_in_tasklist').html('please choose field type!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                return;
            }
            if (type=='string'){
                field_data.fixed_value=$.trim($('#string_fixed_value').val());
                if(field_data.fixed_value==""){  //check fixed value of String
                    $('#alert_in_tasklist').html('please input fixed value!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                    return;
                }
                field_data.suffix_value=$.trim($('#string_suffix_value').val());
            }else if (type=='number'){
                number_type=$('#number_type option:selected').val();
                if(number_type=="Choose Type..."){  //check number type
                    $('#alert_in_tasklist').html('please choose number type!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                    return;
                }
                console.log('number_type is '+number_type);
                value_type=$('#value_type option:selected').val();
                console.log('number value type is '+value_type);
                if(value_type=="Choose Type..."){
                    $('#alert_in_tasklist').html('please choose number value type!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                    return;
                }

                field_data.number_type=number_type;
                field_data.fixed_value=$.trim($('#number_fixed_value').val());
                //console.log('fixed_value is '+field_data.fixed_value);
                field_data.number_start_value=$.trim($('#number_start_value').val());
                field_data.number_step=$.trim($('#number_step').val());
                //console.log('step is '+field_data.number_step);
                field_data.number_range_left=$.trim($('#number_range_left').val());
                field_data.number_range_right=$.trim($('#number_range_right').val());
                field_data.decimal_point=$.trim($('#decimal_point').val());

                //check
                if(value_type=="fixed"){
                    if(field_data.fixed_value==""){
                        $('#alert_in_tasklist').html('please input fixed value!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                        return;
                    }

                }else if(value_type=="autoIncrement"){

                    if(field_data.number_start_value==""){
                        console.log('into or....');
                        $('#alert_in_tasklist').html('please input start value!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                        return;
                    }
                    if(field_data.number_step==""){
                        $('#alert_in_tasklist').html('please input step value!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                        return;
                    }
                    //不是数字就返回
                    if(!checkRate(field_data.number_start_value)){
                        return;
                    }
                    if(!checkRate(field_data.number_step)){
                        return;
                    }

                }else if(value_type=="range"){
                    if(field_data.number_range_left==""){
                        $('#alert_in_tasklist').html('please input range-left value!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                        return;
                    }
                    if(field_data.number_range_right==""){
                        $('#alert_in_tasklist').html('please input range-right value!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                        return;
                    }
                    if(!checkRate(field_data.number_range_left)){
                        return;
                    }
                    if(!checkRate(field_data.number_range_right)){
                        return;
                    }
                    if(parseFloat(field_data.number_range_left)>=parseFloat(field_data.number_range_right)){
                        $('#alert_in_tasklist').html('left should be smaller than right!').removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                        return;
                    }


                }

            }else if(type=='date'){
                date_format=$('#date_format option:selected').val();
                console.log('date_format is '+date_format);
                field_data.date_format=date_format;
                field_data.date_offset=$('#date_offset').val();
                field_data.date_interval=$('#date_interval').val();

            }

            $.ajax({
                //接口地址
                url: "/html/saveField",
                type: 'POST',
                contentType: "application/json;charset=utf-8",
                dataType : 'json',
                data: JSON.stringify(field_data),
                async: false,
                cache: false,
                processData: false,
                success: function (response) {
                    //成功的回调
                    console.log('ok');
                    $("#field_div input").val(""); //保存一个字段后就把上面的输入框清空，以便重新定义新的字段
                    $('#refresh_field_button').click();  //保存一个字段就刷新下面的table


                },
                error: function (returndata) {
                    console.log('boom');
                    //请求异常的回调
                    // modals.warn("网络访问失败，请稍后重试!");
                }
            });

        }

        function refresh_field(r) {
            $.ajax({
                //接口地址
                url: '/html/refreshField' ,
                type: 'POST',
                data: {},
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    //成功的回调
                    console.log('refresh field success');
                    $('#fieldlist').html(data);
                    $.each(data.fieldList,function(i,item){

                        console.log(i);
                        console.log('type is '+item.type);
                        console.log('name is '+item.name);
                    });

                },
                error: function (returndata) {
                    //请求异常的回调
                    console.log('refresh boom!');
                    // modals.warn("网络访问失败，请稍后重试!");
                }
            });

        }

        function upField(r) {

            console.log('into up_field method.....');
            var tr=r.parentNode.parentNode;
            var fieldname;
            var celllist=tr.cells;
            for(var k=0;k<celllist.length;k++){
                if(celllist[k].id=="fieldname_td"){
                    fieldname=celllist[k].innerText.trim();
                    console.log('fieldname is '+fieldname);
                }
            }
            var d={};
            d.field_name=fieldname;
            $.ajax({
                //接口地址
                url: "/html/upField",
                type: 'POST',
                contentType: "application/json;charset=utf-8",
                dataType : 'json',
                data: JSON.stringify(d),
                async: false,
                cache: false,
                processData: false,
                success: function (response) {
                    //成功的回调
                    if(response.success){
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-warning').addClass('alert-success th_in_tasklist').show().delay(2500).fadeOut();
                    }else{
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                    }
                    $('#refresh_field_button').click();  //刷一下

                },
                error: function (returndata) {
                    //请求异常的回调
                    // modals.warn("网络访问失败，请稍后重试!");
                }
            });
        }

        function downField(r) {

            console.log('into down_field method.....');
            var tr=r.parentNode.parentNode;
            var fieldname;
            var celllist=tr.cells;
            for(var k=0;k<celllist.length;k++){
                if(celllist[k].id=="fieldname_td"){
                    fieldname=celllist[k].innerText.trim();   //出了bug ，不加trim会多几个空格
                    console.log('fieldname is '+fieldname);
                }
            }
            var d={};
            d.field_name=fieldname;
            $.ajax({
                //接口地址
                url: "/html/downField",
                type: 'POST',
                contentType: "application/json;charset=utf-8",
                dataType : 'json',
                data: JSON.stringify(d),
                async: false,
                cache: false,
                processData: false,
                success: function (response) {
                    //成功的回调
                    if(response.success){
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-warning').addClass('alert-success th_in_tasklist').show().delay(2500).fadeOut();
                    }else{
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                    }
                    $('#refresh_field_button').click();  //刷一下

                },
                error: function (returndata) {
                    //请求异常的回调
                    // modals.warn("网络访问失败，请稍后重试!");
                }
            });
        }

        function deleteField(r) {
            console.log('into delete_field method.....');
            var tr=r.parentNode.parentNode;
            var fieldname;
            var celllist=tr.cells;
            for(var k=0;k<celllist.length;k++){
                if(celllist[k].id=="fieldname_td"){
                    fieldname=celllist[k].innerText.trim();
                    console.log('fieldname is '+fieldname);
                }
            }
            var d={};
            d.field_name=fieldname;
            $.ajax({
                //接口地址
                url: "/html/deleteField",
                type: 'POST',
                contentType: "application/json;charset=utf-8",
                dataType : 'json',
                data: JSON.stringify(d),
                async: false,
                cache: false,
                processData: false,
                success: function (response) {
                    //成功的回调
                    if(response.success){
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-warning').addClass('alert-success th_in_tasklist').show().delay(2500).fadeOut();
                    }else{
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                    }
                    $('#refresh_field_button').click();  //刷一下

                },
                error: function (returndata) {
                    //请求异常的回调
                    // modals.warn("网络访问失败，请稍后重试!");
                }
            });

        }

        function goback2chooseDataSource(r) {
            $('#dataSource_out').show();
            $('#dataSource_in').show();
            $('#dataSource_goback').hide();
            $('#file').hide();

        }

        //利用所有字段变成一个json文件或是csv文件
        function field2file(r) {
            $.ajax({
                //接口地址
                url: "/html/field2file",
                type: 'POST',
                contentType: "application/json;charset=utf-8",
                dataType : 'json',
                data: {},
                async: false,
                cache: false,
                processData: false,
                success: function (response) {
                    //成功的回调
                    if(response.success){
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-warning').addClass('alert-success th_in_tasklist').show().delay(2500).fadeOut();
                    }else{
                        $('#alert_in_tasklist').html(response.message).removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(3500).fadeOut();
                    }
                    $('#file_generate_name').val(response.file_name);
                    //$('#file_generate_name').prop('disabled', true);
                    $('#refresh_field_button').click();

                    //---------成功的话关闭Modal

                    //$('#closemodal_field_design').click(); //成功就自动关闭modal框(点Close)


                    //---------------------------------------
                    //$('#modal_field_design').modal('hide');


                    check_file_generate_name();
                    //removeBackground();


                },
                error: function (returndata) {
                    //请求异常的回调
                    // modals.warn("网络访问失败，请稍后重试!");
                }
            });

        }

        //根据integer或decimal设置一些框的显示和隐藏
        function checkNumberType() {
            var option=$("#number_type option:selected").val();
            console.log('number type is '+option);
            if (option=="decimal"&&$("#value_type option:selected").val() != "fixed") {
                //选的是小数且不是固定值
                $('#div_field_number_decimal').show();

             }else{
                $('#div_field_number_decimal').hide();
            }
        }

        //根据固定值或自增或一个范围来设置一些框的显示和隐藏
        function checkValueType() {
            var option=$("#value_type option:selected").val();
            console.log('number value type is '+option);
            if (option=="fixed"){
                $('#div_field_number_fixed').show();
                $('#div_field_number_autoIncrement').hide();
                $('#div_field_number_range').hide();
            }else if (option=="autoIncrement"){
                $('#div_field_number_fixed').hide();
                $('#div_field_number_autoIncrement').show();
                $('#div_field_number_range').hide();
            }else if (option=="range"){
                $('#div_field_number_fixed').hide();
                $('#div_field_number_autoIncrement').hide();
                $('#div_field_number_range').show();
            }else{
                $('#div_field_number_fixed').hide();
                $('#div_field_number_autoIncrement').hide();
                $('#div_field_number_range').hide();
            }
            checkNumberType();


        }

        function removeBackground(){
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open');
        }

        function check_file_generate_name() {
            var value=$('#file_generate_name').val();
            if (value.length>0){
                $('#div_file_generate_name').show();
            }else{
                $('#div_file_generate_name').hide();
            }

        }

        function newModal_close_assist() {
            $("body").addClass("modal-open");
            //$('#exampleModal').css("overflow","auto"); //让旧的modal可以滚动
            var modal_create=document.getElementById('exampleModal');


        }

        function clearInputbyId(id) {


            $("#"+id+" input").val("");

        }



    </script>


</head>

<body ms-controller="viewmodel">

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h2 class="h5">Task List</h2>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group mr-2">
            <a href="#"
               class="btn btn-sm btn-outline-dark"
               data-toggle="modal" data-target="#exampleModal"
               onclick="reset_saveModal(this);">
                <span data-feather="plus"></span>  Add Task
            </a>
            <!--<a href="#" class="btn btn-sm btn-outline-dark" data-toggle="modal" data-target="#exampleModal">   Add Task </a>-->
        </div>

    </div>
</div>


<table class="table table-hover" id="tasklist">
    <thead>
    <tr>
        <th scope="col" class="th_in_tasklist">#</th>
        <th scope="col" class="th_in_tasklist">Task Name</th>
        <th scope="col" class="th_in_tasklist">Topic</th>
        <th scope="col" class="th_in_tasklist">Status</th>
        <th scope="col" class="th_in_tasklist">File Name</th>
        <th scope="col" hidden>json file name</th>  <!-- unique列-->
        <th scope="col" hidden>thread id</th>
        <th scope="col" class="th_in_tasklist">Action</th>



    </tr>
    </thead>
    <tbody id="datalisttoby">


    <!-- 这里是用ajax向后台请求的数据-->
    <tr ms-for="($index, el) in @datalist" name="trintable" >
        <th scope="row" class="td_in_tasklist  align-middle">{{$index+1}}</th>

        <td id="tasknameinlist" class="td_in_tasklist align-middle">{{el.taskname}}</td>
        <td id="topicinlist" class="td_in_tasklist  align-middle">{{el.topic}}</td>
        <td id="statusinlist" class="td_in_tasklist  align-middle" name="statusinlist"><span id="status_span" class="badge badge-pill badge-secondary" style="font-size: 1rem; vertical-align: middle;font-weight: 400">{{el.status}}</span></td>
        <td id="filenameinlist" class="td_in_tasklist  align-middle">{{el.filename}}</td>
        <td hidden id="jsonfilename">{{el.jsonfilename}}</td>
        <td hidden id="threadId">{{el.threadId}}</td>
        <td hidden id="hostinlist">{{el.host}}</td>
        <td hidden id="portinlist">{{el.port}}</td>
        <td hidden id="intervalinlist">{{el.interval}}</td>
        <td hidden id="totaltimeinlist">{{el.time}}</td>
        <td hidden id="patterninlist">{{el.pattern}}</td>

        <td id="ainlist" class="td_in_tasklist align-middle" style="width: 280px">

            <button  type="button" class="btn btn-success a_in_action" id="a_start" name="a_button" onclick="startTask(this);" title="start">start</button>
            <button  type="button" class="btn btn-warning a_in_action" id="a_pause" name="a_button" onclick="pauseTask(this);" title="pause">pause</button>
            <button  type="button" class="btn btn-danger a_in_action" id="a_stop" name="a_button" onclick="stopTask(this);" title="stop"  >stop</button>
            <button  type="button" class="btn btn-secondary  a_in_action" id="a_delete" name="a_button" onclick="mydeleteRow(this);" title="delete" style="background-color: #bc4242;">delete</button>
            <button  type="button" class="btn btn-info a_in_action" id="a_edit" name="a_button" onclick="sendUniqueInfo(this);" data-toggle="modal" data-target="#modal_update" title="edit">edit</button>

        </td>
    </tr>



    </tbody>
</table>
<!-- 修饰alert-->
<div class="alert"
     id="alert_in_tasklist"
     style="z-index: 9999;
            position:absolute;
            top:50px;
            left:160px;
            right: 170px;

                        "


></div>

<!--<button type="button" class="btn btn-primary"  style="margin: 10px;"  ms-click="@request">{{@text}}</button>-->
<button type="button" hidden id="avalonbtn" class="btn btn-primary"  style="margin: 10px;"  ms-click="@request">{{@text}}</button>

<!--<span data-feather="database"></span>-->


<!-- Modal create-->
<div class="modal fade " id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="overflow: auto;">
    <div class="modal-dialog" role="document">

        <form  id="taskform" name="taskform" th:action="@{/html/saveTask}" method="post"  enctype="multipart/form-data">

            <div class="modal-content" style="width: 600px;margin: 0 auto;left: -8%;">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add Task</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>


                <div class="modal-body" style="width: 98%;">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Task Name:</span>
                        </div>
                        <input type="text" class="form-control" name="taskname" id="taskname" onblur="checktaskname(this);"  placeholder="please enter task name" aria-label="serviceName" >
                        <span  id="vali_taskname" style="color: #c82333;font-size: medium;line-height:35px;"></span>

                    </div>

                    <!--文件上传-->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Data Source File:</span>
                        </div>
                        <button  class="btn btn-info" type="button" id="dataSource_out"  onclick="choose_file_from_local(this);" style="margin-left: 10px;height: 90%">Choose Local File</button>
                        <a href="#" id="dataSource_in" class="btn btn-info" data-toggle="modal" data-target="#modal_field_design" style="margin-left: 10px;height: 90%" onclick="show_type_div(this);clearInputbyId('field_div');">Generate Data Here </a>
                        <input type="file" class="form-control" name="file" id="file"  style="display: none" onblur="checkfile(this);"  onchange="selectFile(this)"  aria-label="serviceName" >
                        <button  class="btn btn-info" type="button" id="dataSource_goback"  onclick="goback2chooseDataSource(this);" style="display: none;margin-left: 10px;height: 100%">Go Back</button>
                    </div>

                    <div class="input-group mb-3" id="div_file_generate_name">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">File Generation Name:</span>
                        </div>
                        <input type="text" class="form-control" name="file_generate_name" id="file_generate_name"  onblur="check_file_generate_name();" onchange="check_file_generate_name();"  aria-label="imageName" >

                    </div>


                    <div hidden class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Connector:</span>
                        </div>

                        <select class="custom-select" id="type_connector"   name="connector" style="width: 100px">
                            <option >Choose Type...</option>
                            <option selected value="mqtt" >Mqtt</option>
                            <option value="kafka" >Kafka</option>
                        </select>
                    </div>


                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Mqtt Broker Host:</span>
                        </div>
                        <input type="text" class="form-control" name="host" id="host" onblur="checkhost(this);"  value="mqtt" aria-label="imageName" >
                        <span  id="vali_host" style="color: #c82333;font-size: medium;line-height:35px;"></span>
                    </div>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Mqtt Broker Port:</span>
                        </div>
                        <input type="text" class="form-control" name="port" id="port" onblur="checkport(this);"  value="1883" aria-label="imageName" >
                        <span  id="vali_port" style="color: #c82333;font-size: medium;line-height:35px;"></span>
                    </div>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Message Send Intervals(s):</span>
                        </div>
                        <input type="text" class="form-control" name="interval" id="interval" onblur="checkinterval(this);"  value="2" aria-label="imageName" >
                        <span  id="vali_interval" style="color: #c82333;font-size: medium;line-height:35px;"></span>
                    </div>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Mqtt Message Topic:</span>
                        </div>
                        <input type="text" class="form-control" name="topic" id="topic" onblur="checktopic(this);"  placeholder="please enter topic" aria-label="imageName" >
                        <span  id="vali_topic" style="color: #c82333;font-size: medium;line-height:35px;"></span>
                    </div>

                    <div class="input-group mb-3" style="vertical-align:middle;line-height: 1.5">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Total Send Time:</span>
                        </div>

                        <input type="text" class="form-control" name="time" id="time" onblur="checktotaltime(this);"  value="5" style="width: 20px"  >
                        <span  id="vali_totaltime" style="color: #c82333;font-size: medium;line-height:35px;"></span>

                        <select class="custom-select" id="pattern_select" style="width: 100px" onchange="select2radio(this);" onblur="select2radio(this)">
                            <option >Choose Pattern...</option>
                            <option selected value="minute">minute(s)</option>
                            <option value="second">second(s)</option>
                            <option value="cycle">cycle(s)</option>
                        </select>

                        <div hidden class="input-group-prepend">
                            <input id="radio_minute" type="radio" name="pattern" value="分钟" checked style="margin-top:10px;display: block"><span id="minute_span" style="margin-top:4px;display: inline;">min</span>
                            <input id="radio_second" type="radio" name="pattern" value="秒"  style="margin-top:10px;display: block"><span id="second_span" style="margin-top:4px;display: inline;">sec</span>
                            <input id="radio_cycle" type="radio" name="pattern" value="遍"  style="margin-top:10px;display: block;" ><span id="circle_span" style="margin-top:4px;display: inline;">cycle</span>
                        </div>
                    </div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="closemodal" data-dismiss="modal">Close</button>
                    <button type="button" id="savebutton" class="btn btn-primary" onclick="submitFunction()">Save</button>
                </div>
            </div>
        </form>
    </div>
</div>


<!-- Modal update-->
<div class="modal fade" id="modal_update" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel_update" aria-hidden="true" style="overflow: auto">
    <div class="modal-dialog" role="document">

        <form id="form_update" name="form_update" th:action="@{/html/updateTask}" method="post"  enctype="multipart/form-data">

            <div class="modal-content" style="width: 600px">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel_update">Edit Task</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>


                <div class="modal-body" style="width: 98%;">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Task Name:</span>
                        </div>
                        <input type="text" class="form-control" name="taskname" id="taskname_update" onblur="checktaskname(this);"  placeholder="please enter task name" aria-label="serviceName" >
                    </div>

                    <!-- 按钮，点击后让文件上传出现-->
                    <div id="file_button_div" class="input-group mb-3" style="text-align: center;">
                        <!--<div class="input-group-prepend" style="text-align: center;">-->
                            <button  class="btn btn-info" type="button" id="show_file_upload" style="margin-left: auto;margin-right: auto;" onclick="showFileUpload(this);">Click here to change data source</button>
                        <!--</div>-->

                    </div>
                    <!--文件上传-->
                    <div id="file_upload_div" class="input-group mb-3" style="display:none;">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Data Source File:</span>
                        </div>
                        <input type="file" class="form-control" name="file" id="file_update"  onblur="checkfile(this);"  onchange="selectFile(this)"  aria-label="serviceName" >
                        <span  id="vali_file_update" style="color: #c82333;font-size: medium;line-height:35px;"></span>
                    </div>


                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Mqtt Broker Host:</span>
                        </div>
                        <input type="text" class="form-control" name="host" id="host_update" onblur="checkhost(this);"  value="mqtt" aria-label="imageName" >
                    </div>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Mqtt Broker Port:</span>
                        </div>
                        <input type="text" class="form-control" name="port" id="port_update" onblur="checkport(this);"  value="1883" aria-label="imageName" >
                    </div>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Message Send Intervals(s):</span>
                        </div>
                        <input type="text" class="form-control" name="interval" id="interval_update" onblur="checkinterval(this);"  value="2" aria-label="imageName" >
                    </div>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Mqtt Message Topic:</span>
                        </div>
                        <input type="text" class="form-control" name="topic" id="topic_update" onblur="checktopic(this);"  placeholder="please enter topic" aria-label="imageName" >
                    </div>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Total Send Time:</span>
                        </div>
                        <input type="text" class="form-control" name="time" id="time_update" onblur="checktotaltime(this);"  value="5" aria-label="imageName" >

                        <select class="custom-select" id="pattern_select_update" style="width: 100px" onchange="select2radio_update(this);" onblur="select2radio_update(this)">
                            <option selected>Choose Pattern...</option>
                            <option value="minute">minute(s)</option>
                            <option value="second">second(s)</option>
                            <option value="cycle">cycle(s)</option>
                        </select>
                        <input type="radio" id="pattern_min" name="pattern" value="分钟" style="margin-top:10px;display: none;"><span style="margin-top:4px;display: none;" id="minute_span_update">min</span>
                        <input type="radio" id="pattern_sec" name="pattern" value="秒" style="margin-top:10px;display: none;"><span style="margin-top:4px;display: none;" id="second_span_update">sec</span>
                        <input type="radio" id="pattern_cycle" name="pattern" value="遍" style="margin-top:10px;display: none;"><span style="margin-top:4px;display: none;" id="cycle_span_update">cycle</span>
                    </div>

                    <div hidden class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">json file name:</span>
                        </div>
                        <input type="text" class="form-control" name="jsonfilename" id="jsonname_update"   placeholder="unique jsonname" aria-label="imageName" >
                    </div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="closemodal_update" data-dismiss="modal">Close</button>
                    <button type="button" id="savebutton_update" class="btn btn-primary" onclick="submitUpdate();">Save</button>
                </div>
            </div>
        </form>
    </div>
</div>




<!--Modal field design-->
<div class="modal fade" id="modal_field_design" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel_field_design" aria-hidden="true" style="overflow: auto">
    <div class="modal-dialog" role="document">

        <form  id="form_field_design" name="form_field_design" th:action="@{/html/updateTask}" method="post"  enctype="multipart/form-data">

            <div class="modal-content" style="width: 700px;left: -16%;">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel_field_design">Field Design</h5>
                    <button type="button" id="span_field_x" class="close" data-dismiss="modal" aria-label="Close">
                        <span  aria-hidden="true">&times;</span>
                    </button>
                </div>

                <!--<button  class="btn btn-info button_in_field_design" type="button" id="add_field"  onclick="add_field(this);" >Add Field</button>-->

                <div id="field_div" class="modal-body" style="width: 98%;">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Field Name:</span>
                        </div>
                        <input type="text" class="form-control" name="field_name" id="field_name"   placeholder="please enter field name" aria-label="serviceName" >
                        <span><img src="/image/info.svg" title="This value is the key name in json.."></span>
                    </div>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Field Type:</span>
                        </div>
                        <select class="custom-select" id="type_field_value" name="field_value_type" style="width: 100px" onchange="show_type_div(this);" onblur="show_type_div(this);" onfocus="show_type_div(this)">
                            <option >Choose Type...</option>
                            <option selected value="string" >String</option>
                            <option value="date">Date</option>
                            <option value="number">Number</option>
                        </select>
                        <span><img src="/image/info.svg" title="Choose one of three types.">
                    </div>
                    <!-- div for string-->
                    <div  id="div_field_string" >
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Fixed Value<span style="color: #bd2130">(*)</span>:</span>
                            </div>
                            <!--<span data-feather="info" title="every data use same value"></span>-->
                            <input type="text" class="form-control" name="fixed_value" id="string_fixed_value"  >
                            <span><img src="/image/info.svg" title="Every data use same value"></span>

                        </div>

                        <div hidden class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;"
                                >Suffix Number Start:</span>
                            </div>
                            <input type="text" class="form-control" name="suffix_value" id="string_suffix_value"  >
                            <span><img src="/image/info.svg" title="if fixed value is  &quot;sensor&quot;,suffix is 1,
field value will be &quot;sensor1&quot;,&quot;sensor2&quot;,&quot;sensor3&quot;……
this input is not neccessary"></span>
                        </div>

                    </div>
                    <!-- div for date-->
                    <div  id="div_field_date" >
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Date Format:</span>
                            </div>
                            <select class="custom-select" id="date_format" name="date_format" style="width: 100px" onchange="" onblur="" onfocus="">
                                <option >Choose Format...</option>
                                <option selected value="yyyy-MM-dd" >yyyy-MM-dd</option>
                                <option value="yyyy-MM-dd HH:mm:ss">yyyy-MM-dd HH:mm:ss</option>
                                <option value="yyyy-MM-dd HH:00:00">yyyy-MM-dd HH:00:00</option>
                            </select>
                            <span><img src="/image/info.svg" title="Choose date format for timestamp."></span>
                        </div>

                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Offset:</span>
                            </div>
                            <input type="text" class="form-control" name="date_offset" id="date_offset"  >
                            <span class="input-group-text" style="display:block; width: 70px;float:right; text-align:right;">hour(s)</span>
                            <span><img src="/image/info.svg" title="if this value is 1 and current time is 16:00,
it means the first json data's date value is 15:00."></span>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">interval:</span>
                            </div>

                            <input type="text" class="form-control" name="date_interval" id="date_interval"  >
                            <span class="input-group-text" style="display:block; width: 85px;float:right; text-align:right;">second(s)</span>
                            <span><img src="/image/info.svg" title="if this value is 2 and first json data's date is 16:00:00,
it means the second json data's date value is 16:00:02,
the third json data's date value is 16:00:04……"></span>
                        </div>


                    </div>
                    <!-- div for number-->
                    <div  id="div_field_number" >
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Number Type:</span>
                            </div>
                            <select class="custom-select" id="number_type" name="number_type" style="width: 100px" onchange="checkNumberType();" onblur="checkNumberType();" onfocus="checkNumberType();">
                                <option >Choose Type...</option>
                                <option selected value="integer" >Integer</option>
                                <option value="decimal">Decimal</option>
                            </select>
                            <span><img src="/image/info.svg" title="Choose number type."></span>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Value Type:</span>
                            </div>
                            <select class="custom-select" id="value_type" name="value_type" style="width: 100px" onchange="checkValueType();" onblur="checkValueType();" onfocus="checkValueType();">
                                <option >Choose Type...</option>
                                <option selected value="fixed" >Fixed</option>
                                <option value="autoIncrement">Auto Increment</option>
                                <option value="range">random number in range</option>
                            </select>
                            <span><img src="/image/info.svg" title="Choose value type."></span>
                        </div>

                        <div class="input-group mb-3" id="div_field_number_fixed">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Fixed Value<span style="color: #bd2130">(*)</span>:</span>
                            </div>
                            <input type="text" class="form-control" name="fixed_value" id="number_fixed_value"  >
                            <span><img src="/image/info.svg" title="Every data use same value"></span>
                        </div>

                        <div class="input-group mb-3" id="div_field_number_autoIncrement">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Auto Increment:</span>
                            </div>
                            <span class="input-group-text" style="display:block; width: 52px; float:left; text-align:right;">Start:&nbsp;</span>

                            <input type="text" class="form-control" name="number_start_value" id="number_start_value"  >
                            <span class="input-group-text" style="display:block; width: 52px; float:left; text-align:right;">Step:&nbsp;</span>
                            <input type="text" class="form-control" name="number_step" id="number_step"  >
                            <span><img src="/image/info.svg" title="If start is 2, step is 1, data is 2,3,4,5,6……"></span>

                        </div>


                        <div class="input-group mb-3" id="div_field_number_range">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Range:</span>
                            </div>
                            <span class="input-group-text" style="display:block; width: 46px; float:left; text-align:right;">Left:&nbsp;</span>
                            <input type="text" class="form-control" name="number_range_left" id="number_range_left"  >
                            <span class="input-group-text" style="display:block; width: 58px; float:left; text-align:right;">Right:&nbsp;</span>
                            <input type="text" class="form-control" name="number_range_right" id="number_range_right"  >
                            <span><img src="/image/info.svg" title="Number value is the random number in [left,right]"></span>
                        </div>

                        <div class="input-group mb-3" id="div_field_number_decimal">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="display:block; width: 210px; float:left; text-align:right;">Decimal Point:</span>
                            </div>
                            <input type="text" class="form-control" name="decimal_point" id="decimal_point"  >
                            <span><img src="/image/info.svg" title="if this value is 2,
it means there are two decimal places after decimal point."></span>
                        </div>

                    </div>

                    <button  class="btn btn-info button_in_field_design" type="button" id="save_field_button"  onclick="save_field(this);" >Save Field</button>
                    <button  hidden class="btn btn-info button_in_field_design" type="button" id="refresh_field_button"  onclick="refresh_field(this);" >Refresh</button>

                    <table class="table table-hover" id="fieldlist" th:fragment="fieldlist">
                        <thead>
                        <tr>
                            <th scope="col" class="th_in_tasklist">#</th>
                            <th scope="col" class="th_in_tasklist">Name</th>
                            <th scope="col" class="th_in_tasklist">Type</th>
                            <th scope="col" class="th_in_tasklist">Value</th>
                            <th scope="col" class="th_in_tasklist">Action</th>

                        </tr>
                        </thead>
                        <tbody id="fieldlisttoby">
                        <!-- 这里是用ajax向后台请求的数据-->
                        <tr th:each="ele,eleStat : ${fieldList}" name="field_table" >

                            <th scope="row" class="td_in_tasklist  align-middle" th:text="${eleStat.count}"></th>
                            <td id="fieldname_td" class="td_in_tasklist align-middle" th:text="${ele.name}"></td>
                            <td class="td_in_tasklist align-middle" th:text="${ele.type}"></td>
                            <td class="td_in_tasklist align-middle" th:text="${ele.example_value}"></td>
                            <td class="td_in_tasklist align-middle">
                                <!--<button  type="button" class="btn btn-success btn-sm field_in_action" id="up_field" name="up_field" onclick="upField(this);" title="up">up</button>-->
                                <!--<button  type="button" class="btn btn-warning btn-sm field_in_action" id="down_field" name="down_field" onclick="downField(this);" title="down">down</button>-->
                                <!--<button  type="button" class="btn btn-danger btn-sm field_in_action" id="delete_field" name="delete_field" onclick="deleteField(this);" title="delete">delete</button>-->

                                <a id="up_field" name="up_field" href="javascript:;" onclick='{upField(this);}'  title="move field up"><img src="/image/arrow-up.svg"  ></a>
                                <a id="down_field" name="down_field" href="javascript:;" onclick='{downField(this);}'  title="move field down"><img src="/image/arrow-down.svg"  ></a>
                                <a id="delete_field" name="delete_field" href="javascript:;" onclick='{deleteField(this);}'  title="delete field"><img src="/image/delete.svg"  ></a>
                            </td>
                        </tr>



                        </tbody>
                    </table>



                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="closemodal_field_design" data-dismiss="modal" onclick="newModal_close_assist();">Close</button>
                    <button type="button" id="savebutton_field_design" class="btn btn-primary" onclick="field2file(this);" title="save all fields to json format file">Save</button>


                </div>
            </div>
        </form>
    </div>
</div>



</body>

<!-- for websocket-->
<script type="text/javascript">
    var websocket = null;
    //判断当前浏览器是否支持WebSocket
    if('WebSocket' in window){
        var hostname = location.hostname;
        var port = location.port;
        websocket = new WebSocket("ws://"+hostname+":"+port+"/html/home/service");
    }else{
        console.log('Not support websocket');
    }

    //连接发生错误的回调方法
    websocket.onerror = function(){
        //setMessageInnerHTML("error");
        console.log('connection error');
    };

    //连接成功建立的回调方法
    websocket.onopen = function(event){
        console.log('websocket connection is built...');
        //setMessageInnerHTML("open");
    };

    //接收到消息的回调方法
    websocket.onmessage = function(event){
        var message=event.data;
        if(message=="refresh"){
            console.log('get message, go to refresh!!!');
            viewmodel.request();
        }else{
            //其他的作为通知显示
            $('#alert_in_tasklist').html(message).removeClass('alert-success').addClass('alert-warning th_in_tasklist').show().delay(2500).fadeOut();

        }


        console.log('receive message...');
        //setMessageInnerHTML(event.data);
    };

    //连接关闭的回调方法
    websocket.onclose = function(){
        console.log('connection close');
        //setMessageInnerHTML("close");
    };

    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function(){
        websocket.close();
    };

    //将消息显示在控制台
    function setMessageInnerHTML(innerHTML){
        //document.getElementById('message').innerHTML += innerHTML + '<br/>';
        console.log(innerHTML);
    }

    //关闭连接
    function closeWebSocket(){
        websocket.close();
    }


    //发送消息
    function send(){
        //var message = document.getElementById('text').value;
        var message="mess_test";
        websocket.send(message);
    }
</script>



</html>